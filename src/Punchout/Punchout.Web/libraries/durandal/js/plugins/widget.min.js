define(["durandal/system","durandal/composition","jquery","knockout"],function(n,t,i,r){function s(n,i){var u=r.utils.domData.get(n,o);u||(u={parts:t.cloneNodes(r.virtualElements.childNodes(n))},r.virtualElements.emptyNode(n),r.utils.domData.set(n,o,u));i.parts=u.parts}var f={},e={},h=["model","view","kind"],o="durandal-widget-data",u={getSettings:function(t){var i=r.utils.unwrapObservable(t())||{},u;if(n.isString(i))return{kind:i};for(u in i)i[u]=r.utils.arrayIndexOf(h,u)!=-1?r.utils.unwrapObservable(i[u]):i[u];return i},registerKind:function(n){r.bindingHandlers[n]={init:function(){return{controlsDescendantBindings:!0}},update:function(t,i,r,f,e){var o=u.getSettings(i);o.kind=n;s(t,o);u.create(t,o,e,!0)}};r.virtualElements.allowedBindings[n]=!0;t.composeBindings.push(n+":")},mapKind:function(n,t,i){t&&(e[n]=t);i&&(f[n]=i)},mapKindToModuleId:function(n){return f[n]||u.convertKindToModulePath(n)},convertKindToModulePath:function(n){return"widgets/"+n+"/viewmodel"},mapKindToViewId:function(n){return e[n]||u.convertKindToViewPath(n)},convertKindToViewPath:function(n){return"widgets/"+n+"/view"},createCompositionSettings:function(n,t){return t.model||(t.model=this.mapKindToModuleId(t.kind)),t.view||(t.view=this.mapKindToViewId(t.kind)),t.preserveContext=!0,t.activate=!0,t.activationData=t,t.mode="templated",t},create:function(n,i,r,f){f||(i=u.getSettings(function(){return i},n));var e=u.createCompositionSettings(n,i);t.compose(n,e,r)},install:function(n){var f,i;if(n.bindingName=n.bindingName||"widget",n.kinds)for(f=n.kinds,i=0;i<f.length;i++)u.registerKind(f[i]);r.bindingHandlers[n.bindingName]={init:function(){return{controlsDescendantBindings:!0}},update:function(n,t,i,r,f){var e=u.getSettings(t);s(n,e);u.create(n,e,f,!0)}};t.composeBindings.push(n.bindingName+":");r.virtualElements.allowedBindings[n.bindingName]=!0}};return u})