define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(n,t,i,r,u,f,e,o){function a(n){return n=n.replace(nt,"\\$&").replace(d,"(?:$1)?").replace(v,function(n,t){return t?n:"([^/]+)"}).replace(g,"(.*?)"),new RegExp("^"+n+"$",y?undefined:"i")}function p(n){var t=n.indexOf(":"),i=t>0?t-1:n.length;return n.substring(0,i)}function w(n,t){return n.indexOf(t,n.length-t.length)!==-1}function it(n,t){if(!n||!t||n.length!=t.length)return!1;for(var i=0,r=n.length;i<r;i++)if(n[i]!=t[i])return!1;return!0}function b(n){return n.queryString?n.fragment+"?"+n.queryString:n.fragment}var d=/\((.*?)\)/g,v=/(\(\?)?:\w+/g,g=/\*\w+/g,nt=/[\-{}\[\]+?.,\\\^$|#\s]/g,h,s,tt=/\/$/,y=!1,c="/",l="/",k=function(){function ct(n,t){return n.router&&n.router.parent==t}function lt(n){y&&y.config.isActive&&y.config.isActive(n)}function pt(t,i,r){var f,e;n.log("Navigation Complete",t,i);f=n.getModuleId(o);f&&u.trigger("router:navigation:from:"+f);o=t;lt(!1);y=i;lt(!0);e=n.getModuleId(o);e&&u.trigger("router:navigation:to:"+e);ct(t,u)||u.updateDocumentTitle(t,i);switch(r){case"rootRouter":c=b(y);break;case"rootRouterWithChild":l=b(y);break;case"lastChildRouter":c=l}s.explicitNavigation=!1;s.navigatingBack=!1;u.trigger("router:navigation:complete",t,i,u)}function nt(t,i){n.log("Navigation Cancelled");u.activeInstruction(y);u.navigate(c,!1);g(!1);s.explicitNavigation=!1;s.navigatingBack=!1;u.trigger("router:navigation:cancelled",t,i,u)}function ft(t){n.log("Navigation Redirecting");g(!1);s.explicitNavigation=!1;s.navigatingBack=!1;u.navigate(t,{trigger:!0,replace:!0})}function et(t,i,r){s.navigatingBack=!s.explicitNavigation&&o!=r.fragment;u.trigger("router:route:activating",i,r,u);var f={canDeactivate:!u.parent};t.activateItem(i,r.params,f).then(function(n){var s;if(n){var c=o,f=ct(i,u),e="";u.parent?f||(e="lastChildRouter"):e=f?"rootRouterWithChild":"rootRouter";pt(i,r,e);f&&(i.router.trigger("router:route:before-child-routes",i,r,u),s=r.fragment,r.queryString&&(s+="?"+r.queryString),i.router.loadUrl(s));c==i&&(u.attached(),u.compositionComplete())}else t.settings.lifecycleData&&t.settings.lifecycleData.redirect?ft(t.settings.lifecycleData.redirect):nt(i,r);h&&(h.resolve(),h=null)}).fail(function(t){n.error(t)})}function wt(t,i,r){var f=u.guardRoute(i,r);f||f===""?f.then?f.then(function(u){u?n.isString(u)?ft(u):et(t,i,r):nt(i,r)}):n.isString(f)?ft(f):et(t,i,r):nt(i,r)}function ot(n,t,i){u.guardRoute?wt(n,t,i):et(n,t,i)}function bt(n){return y&&y.config.moduleId==n.config.moduleId&&o&&(o.canReuseForRoute&&o.canReuseForRoute.apply(o,n.params)||!o.canReuseForRoute&&o.router&&o.router.loadUrl)}function at(){var t,r;g()||(t=ut.shift(),ut=[],t)&&(g(!0),u.activeInstruction(t),u.trigger("router:navigation:processing",t,u),bt(t)?(r=i.create(),r.forceActiveItem(o),r.settings.areSameItem=d.settings.areSameItem,r.settings.findChildActivator=d.settings.findChildActivator,ot(r,o,t)):t.config.moduleId?n.acquire(t.config.moduleId).then(function(i){var r=n.resolveObject(i);t.config.viewUrl&&(r.viewUrl=t.config.viewUrl);ot(d,r,t)}).fail(function(i){nt(null,t);n.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+i.message,i)}):ot(d,{viewUrl:t.config.viewUrl,canReuseForRoute:function(){return!0}},t))}function st(n){ut.unshift(n);at()}function vt(n,t,i){for(var o,e,r=n.exec(t).slice(1),f=0;f<r.length;f++)o=r[f],r[f]=o?decodeURIComponent(o):null;return e=u.parseQueryString(i),e&&r.push(e),{params:r,queryParams:e}}function yt(t){u.trigger("router:route:before-config",t,u);n.isRegExp(t.route)?t.routePattern=t.route:(t.title=t.title||u.convertRouteToTitle(t.route),t.viewUrl||(t.moduleId=t.moduleId||u.convertRouteToModuleId(t.route)),t.hash=t.hash||u.convertRouteToHash(t.route),t.hasChildRoutes&&(t.route=t.route+"*childRoutes"),t.routePattern=a(t.route));t.isActive=t.isActive||e.observable(!1);u.trigger("router:route:after-config",t,u);u.routes.push(t);u.route(t.routePattern,function(n,i){var r=vt(t.routePattern,n,i);st({fragment:n,queryString:i,config:t,params:r.params,queryParams:r.queryParams})})}function kt(t){var f,i,o,r;if(n.isArray(t.route))for(f=t.isActive||e.observable(!1),i=0,o=t.route.length;i<o;i++)r=n.extend({},t),r.route=t.route[i],r.isActive=f,i>0&&delete r.nav,yt(r);else yt(t);return u}function rt(n){var i=e.unwrap(t.title);document.title=i?n+" | "+i:n}var ut=[],g=e.observable(!1),o,y,d=i.create(),u={handlers:[],routes:[],navigationModel:e.observableArray([]),activeItem:d,isNavigating:e.computed(function(){var n=d(),t=g(),i=n&&n.router&&n.router!=u&&n.router.isNavigating()?!0:!1;return t||i}),activeInstruction:e.observable(null),__router__:!0},ht;return r.includeIn(u),d.settings.areSameItem=function(n,t,i,r){return n==t?it(i,r):!1},d.settings.findChildActivator=function(n){return n&&n.router&&n.router.parent==u?n.router.activeItem:null},u.parseQueryString=function(t){var r,u,f,i;if(!t||(u=t.split("&"),u.length==0))return null;for(r={},f=0;f<u.length;f++)if(i=u[f],i!==""){var e=i.indexOf("="),s=e===-1?i:i.substr(0,e),h=e===-1?null:decodeURIComponent(i.substr(e+1).replace(/\+/g," ")),o=r[s];o?n.isArray(o)?o.push(h):r[s]=[o,h]:r[s]=h}return r},u.route=function(n,t){u.handlers.push({routePattern:n,callback:t})},u.loadUrl=function(t){var a=u.handlers,v=null,i=t,r=t.indexOf("?"),o,e,h;for(r!=-1&&(i=t.substring(0,r),v=t.substr(r+1)),u.relativeToParentRouter&&(o=this.parent.activeInstruction(),i=r==-1?o.params.join("/"):o.params.slice(0,-1).join("/"),i&&i.charAt(0)=="/"&&(i=i.substr(1)),i||(i=""),i=i.replace("//","/").replace("//","/")),i=i.replace(tt,""),e=0;e<a.length;e++)if(h=a[e],h.routePattern.test(i))return h.callback(i,v),!0;return n.log("Route Not Found",t,y),u.trigger("router:route:not-found",t,u),u.parent&&(c=l),f.navigate(c,{trigger:!1,replace:!0}),s.explicitNavigation=!1,s.navigatingBack=!1,!1},e.isObservable(t.title)&&t.title.subscribe(function(){var n=u.activeInstruction(),t=n!=null?e.unwrap(n.config.title):"";rt(t)}),u.updateDocumentTitle=function(n,i){var u=e.unwrap(t.title),r=i.config.title;ht&&ht.dispose();r?e.isObservable(r)?(ht=r.subscribe(rt),rt(r())):rt(r):u&&(document.title=u)},u.navigate=function(t,i){return t&&t.indexOf("://")!=-1?(window.location.href=t,!0):((i===undefined||n.isBoolean(i)&&i||n.isObject(i)&&i.trigger)&&(s.explicitNavigation=!0),(n.isBoolean(i)&&!i||i&&i.trigger!=undefined&&!i.trigger)&&(c=t),f.navigate(t,i))},u.navigateBack=function(){f.navigateBack()},u.attached=function(){u.trigger("router:navigation:attached",o,y,u)},u.compositionComplete=function(){g(!1);u.trigger("router:navigation:composition-complete",o,y,u);at()},u.convertRouteToHash=function(n){if(n=n.replace(/\*.*$/,""),u.relativeToParentRouter){var i=u.parent.activeInstruction(),t=n?i.config.hash+"/"+n:i.config.hash;return f._hasPushState&&(t="/"+t),t.replace("//","/").replace("//","/")}return f._hasPushState?n:"#"+n},u.convertRouteToModuleId=function(n){return p(n)},u.convertRouteToTitle=function(n){var t=p(n);return t.substring(0,1).toUpperCase()+t.substring(1)},u.map=function(t,i){if(n.isArray(t)){for(var r=0;r<t.length;r++)u.map(t[r]);return u}return n.isString(t)||n.isRegExp(t)?(i?n.isString(i)&&(i={moduleId:i}):i={},i.route=t):i=t,kt(i)},u.buildNavigationModel=function(t){for(var i,r=[],e=u.routes,o=t||100,f=0;f<e.length;f++)i=e[f],i.nav&&(n.isNumber(i.nav)||(i.nav=++o),r.push(i));return r.sort(function(n,t){return n.nav-t.nav}),u.navigationModel(r),u},u.mapUnknownRoutes=function(t,i){var e="*catchall",r=a(e);return u.route(r,function(o,s){var l=vt(r,o,s),h={fragment:o,queryString:s,config:{route:e,routePattern:r},params:l.params,queryParams:l.queryParams},c;if(t)if(n.isString(t))h.config.moduleId=t,i&&f.navigate(i,{trigger:!1,replace:!0});else if(n.isFunction(t)){if(c=t(h),c&&c.then){c.then(function(){u.trigger("router:route:before-config",h.config,u);u.trigger("router:route:after-config",h.config,u);st(h)});return}}else h.config=t,h.config.route=e,h.config.routePattern=r;else h.config.moduleId=o;u.trigger("router:route:before-config",h.config,u);u.trigger("router:route:after-config",h.config,u);st(h)}),u},u.reset=function(){return y=o=undefined,u.handlers=[],u.routes=[],u.off(),delete u.options,u},u.makeRelative=function(t){return n.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!w(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!w(t.route,"/")&&(t.route+="/"),t.fromParent&&(u.relativeToParentRouter=!0),u.on("router:route:before-config").then(function(n){t.moduleId&&(n.moduleId=t.moduleId+n.moduleId);t.route&&(n.route=n.route===""?t.route.substring(0,t.route.length-1):t.route+n.route)}),t.dynamicHash&&(u.on("router:route:after-config").then(function(n){n.routePattern=a(n.route?t.dynamicHash+"/"+n.route:t.dynamicHash);n.dynamicHash=n.dynamicHash||e.observable(n.hash)}),u.on("router:route:before-child-routes").then(function(n,t){for(var i,f,r=n.router,u=0;u<r.routes.length;u++)i=r.routes[u],f=t.params.slice(0),i.hash=r.convertRouteToHash(i.route).replace(v,function(n){return f.length>0?f.shift():n}),i.dynamicHash(i.hash)})),u},u.createChildRouter=function(){var n=k();return n.parent=u,n},u};return s=k(),s.explicitNavigation=!1,s.navigatingBack=!1,s.makeRoutesCaseSensitive=function(){y=!0},s.targetIsThisWindow=function(n){var t=o(n.target).attr("target");return!t||t===window.name||t==="_self"||t==="top"&&window===window.top?!0:!1},s.activate=function(t){return n.defer(function(i){var r,u,e,c;if(h=i,s.options=n.extend({routeHandler:s.loadUrl},s.options,t),f.activate(s.options),f._hasPushState)for(r=s.routes,u=r.length;u--;)e=r[u],e.hash=e.hash.replace("#","/");c=s.options.root&&new RegExp("^"+s.options.root+"/");o(document).delegate("a","click",function(n){if(!n.isDefaultPrevented())if(f._hasPushState){if(!n.altKey&&!n.ctrlKey&&!n.metaKey&&!n.shiftKey&&s.targetIsThisWindow(n)){var t=o(this).attr("href");t==null||t.charAt(0)==="#"||/^[a-z]+:/i.test(t)||(s.explicitNavigation=!0,n.preventDefault(),c&&(t=t.replace(c,"")),f.navigate(t))}}else s.explicitNavigation=!0});f.options.silent&&h&&(h.resolve(),h=null)}).promise()},s.deactivate=function(){s.activeItem(null);f.deactivate()},s.install=function(){e.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(n,t,i,r,f){var o=e.utils.unwrapObservable(t())||{},h;o.__router__?o={model:o.activeItem(),attached:o.attached,compositionComplete:o.compositionComplete,activate:!1}:(h=e.utils.unwrapObservable(o.router||r.router)||s,o.model=h.activeItem(),o.attached=h.attached,o.compositionComplete=h.compositionComplete,o.activate=!1);u.compose(n,o,f)}};e.virtualElements.allowedBindings.router=!0},s})