define(["durandal/system","jquery"],function(n,t){function u(n,t,r){if(r){var u=n.href.replace(/(javascript:|#).*$/,"");i.history.replaceState?i.history.replaceState({},document.title,u+"#"+t):n.replace(u+"#"+t)}else n.hash="#"+t}var r=/^[#\/]|\s+$/g,f=/^\/+|\/+$/g,e=/msie [\w.]+/,o=/\/$/,i={interval:50,active:!1};return typeof window!="undefined"&&(i.location=window.location,i.history=window.history),i.getHash=function(n){var t=(n||i).location.href.match(/#(.*)$/);return t?t[1]:""},i.getFragment=function(n,t){if(n==null)if(i._hasPushState||!i._wantsHashChange||t){n=i.location.pathname+i.location.search;var u=i.root.replace(o,"");n.indexOf(u)||(n=n.substr(u.length))}else n=i.getHash();return n.replace(r,"")},i.activate=function(u){var o,s;i.active&&n.error("History has already been activated.");i.active=!0;i.options=n.extend({},{root:"/"},i.options,u);i.root=i.options.root;i._wantsHashChange=i.options.hashChange!==!1;i._wantsPushState=!!i.options.pushState;i._hasPushState=!!(i.options.pushState&&i.history&&i.history.pushState);var h=i.getFragment(),c=document.documentMode,l=e.exec(navigator.userAgent.toLowerCase())&&(!c||c<=7);if(i.root=("/"+i.root+"/").replace(f,"/"),l&&i._wantsHashChange&&(i.iframe=t('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,i.navigate(h,!1)),i._hasPushState)t(window).on("popstate",i.checkUrl);else if(i._wantsHashChange&&"onhashchange"in window&&!l)t(window).on("hashchange",i.checkUrl);else i._wantsHashChange&&(i._checkUrlInterval=setInterval(i.checkUrl,i.interval));if(i.fragment=h,o=i.location,s=o.pathname.replace(/[^\/]$/,"$&/")===i.root,i._wantsHashChange&&i._wantsPushState)if(i._hasPushState||s)i._hasPushState&&s&&o.hash&&(this.fragment=i.getHash().replace(r,""),this.history.replaceState({},document.title,i.root+i.fragment+o.search));else return i.fragment=i.getFragment(null,!0),i.location.replace(i.root+i.location.search+"#"+i.fragment),!0;if(!i.options.silent)return i.loadUrl(u.startRoute)},i.deactivate=function(){t(window).off("popstate",i.checkUrl).off("hashchange",i.checkUrl);clearInterval(i._checkUrlInterval);i.active=!1},i.checkUrl=function(){var n=i.getFragment();if(n===i.fragment&&i.iframe&&(n=i.getFragment(i.getHash(i.iframe))),n===i.fragment)return!1;i.iframe&&i.navigate(n,!1);i.loadUrl()},i.loadUrl=function(n){var t=i.fragment=i.getFragment(n);return i.options.routeHandler?i.options.routeHandler(t):!1},i.navigate=function(t,r){if(!i.active)return!1;if(r===undefined?r={trigger:!0}:n.isBoolean(r)&&(r={trigger:r}),t=i.getFragment(t||""),i.fragment!==t){i.fragment=t;var f=i.root+t;if(t===""&&f!=="/"&&(f=f.slice(0,-1)),i._hasPushState)i.history[r.replace?"replaceState":"pushState"]({},document.title,f);else if(i._wantsHashChange)u(i.location,t,r.replace),i.iframe&&t!==i.getFragment(i.getHash(i.iframe))&&(r.replace||i.iframe.document.open().close(),u(i.iframe.location,t,r.replace));else return i.location.assign(f);if(r.trigger)return i.loadUrl(t)}},i.navigateBack=function(){i.history.back()},i})