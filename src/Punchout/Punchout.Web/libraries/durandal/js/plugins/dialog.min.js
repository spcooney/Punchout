define(["durandal/system","durandal/app","durandal/composition","durandal/activator","durandal/viewEngine","jquery","knockout"],function(n,t,i,r,u,f,e){function l(t){return n.defer(function(i){n.isString(t)?n.acquire(t).then(function(t){i.resolve(n.resolveObject(t))}).fail(function(i){n.error("Failed to load dialog module ("+t+"). Details: "+i.message)}):i.resolve(t)}).promise()}var c={},h=e.observable(0),s,o=function(n,t,i,r,u){this.message=n;this.title=t||o.defaultTitle;this.options=i||o.defaultOptions;this.autoclose=r||!1;this.settings=f.extend({},o.defaultSettings,u)};return o.prototype.selectOption=function(n){s.close(this,n)},o.prototype.getView=function(){return u.processMarkup(o.defaultViewMarkup)},o.setViewUrl=function(n){delete o.prototype.getView;o.prototype.viewUrl=n},o.defaultTitle=t.title||"Application",o.defaultOptions=["Ok"],o.defaultSettings={buttonClass:"btn btn-default",primaryButtonClass:"btn-primary autofocus",secondaryButtonClass:"","class":"modal-content messageBox",style:null},o.setDefaults=function(n){f.extend(o.defaultSettings,n)},o.prototype.getButtonClass=function(n){var t="";return this.settings&&(this.settings.buttonClass&&(t=this.settings.buttonClass),n()===0&&this.settings.primaryButtonClass&&(t.length>0&&(t+=" "),t+=this.settings.primaryButtonClass),n()>0&&this.settings.secondaryButtonClass&&(t.length>0&&(t+=" "),t+=this.settings.secondaryButtonClass)),t},o.prototype.getClass=function(){return this.settings?this.settings["class"]:"messageBox"},o.prototype.getStyle=function(){return this.settings?this.settings.style:null},o.prototype.getButtonText=function(t){var i=f.type(t);return i==="string"?t:i==="object"?f.type(t.text)==="string"?t.text:(n.error("The object for a MessageBox button does not have a text property that is a string."),null):(n.error("Object for a MessageBox button is not a string or object but "+i+"."),null)},o.prototype.getButtonValue=function(t){var i=f.type(t);return i==="string"?t:i==="object"?f.type(t.value)==="undefined"?(n.error("The object for a MessageBox button does not have a value property defined."),null):t.value:(n.error("Object for a MessageBox button is not a string or object but "+i+"."),null)},o.defaultViewMarkup='<div data-view="plugins/messageBox" data-bind="css: getClass(), style: getStyle()">\n<div class="modal-header">\n<h3 data-bind="html: title"><\/h3>\n<\/div>\n<div class="modal-body">\n<p class="message" data-bind="html: message"><\/p>\n<\/div>\n<div class="modal-footer">\n<!-- ko foreach: options -->\n<button data-bind="click: function () { $parent.selectOption($parent.getButtonValue($data)); }, text: $parent.getButtonText($data), css: $parent.getButtonClass($index)"><\/button>\n<!-- /ko -->\n<div style="clear:both;"><\/div>\n<\/div>\n<\/div>',s={MessageBox:o,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex},isOpen:e.computed(function(){return h()>0}),getContext:function(n){return c[n||"default"]},addContext:function(n,t){t.name=n;c[n]=t;var i="show"+n.substr(0,1).toUpperCase()+n.substr(1);this[i]=function(t,i){return this.show(t,i,n)}},createCompositionSettings:function(n,t){var i={model:n,activate:!1,transition:!1};return t.binding&&(i.binding=t.binding),t.attached&&(i.attached=t.attached),t.compositionComplete&&(i.compositionComplete=t.compositionComplete),i},getDialog:function(n){return n?n.__dialog__:undefined},close:function(n){var t=this.getDialog(n),i;t&&(i=Array.prototype.slice.call(arguments,1),t.close.apply(t,i))},show:function(t,u,f){var o=this,e=c[f||"default"];return n.defer(function(n){l(t).then(function(t){var f=r.create();f.activateItem(t,u).then(function(r){if(r){var u=t.__dialog__={owner:t,context:e,activator:f,close:function(){var i=arguments;f.deactivateItem(t,!0).then(function(r){r&&(h(h()-1),e.removeHost(u),delete t.__dialog__,i.length===0?n.resolve():i.length===1?n.resolve(i[0]):n.resolve.apply(n,i))})}};u.settings=o.createCompositionSettings(t,e);e.addHost(u);h(h()+1);i.compose(u.host,u.settings)}else n.resolve(!1)})})}).promise()},showMessage:function(t,i,r,u,f){return n.isString(this.MessageBox)?s.show(this.MessageBox,[t,i||o.defaultTitle,r||o.defaultOptions,u||!1,f||{}]):s.show(new this.MessageBox(t,i,r,u,f))},install:function(n){t.showDialog=function(n,t,i){return s.show(n,t,i)};t.closeDialog=function(){return s.close.apply(s,arguments)};t.showMessage=function(n,t,i,r,u){return s.showMessage(n,t,i,r,u)};n.messageBox&&(s.MessageBox=n.messageBox);n.messageBoxView&&(s.MessageBox.prototype.getView=function(){return u.processMarkup(n.messageBoxView)});n.messageBoxViewUrl&&s.MessageBox.setViewUrl(n.messageBoxViewUrl)}},s.addContext("default",{blockoutOpacity:.2,removeDelay:200,minYMargin:5,minXMargin:5,addHost:function(n){var t=f("body"),u=f('<div class="modalBlockout"><\/div>').css({"z-index":s.getNextZIndex(),opacity:this.blockoutOpacity}).appendTo(t),e=f('<div class="modalHost"><\/div>').css({"z-index":s.getNextZIndex()}).appendTo(t),r;if(n.host=e.get(0),n.blockout=u.get(0),!s.isOpen()){n.oldBodyMarginRight=t.css("margin-right");n.oldInlineMarginRight=t.get(0).style.marginRight;var i=f("html"),o=t.outerWidth(!0),h=i.scrollTop();f("html").css("overflow-y","hidden");r=f("body").outerWidth(!0);t.css("margin-right",r-o+parseInt(n.oldBodyMarginRight,10)+"px");i.scrollTop(h)}},removeHost:function(n){if(f(n.host).css("opacity",0),f(n.blockout).css("opacity",0),setTimeout(function(){e.removeNode(n.host);e.removeNode(n.blockout)},this.removeDelay),!s.isOpen()){var t=f("html"),i=t.scrollTop();t.css("overflow-y","").scrollTop(i);n.oldInlineMarginRight?f("body").css("margin-right",n.oldBodyMarginRight):f("body").css("margin-right","")}},attached:function(n){f(n).css("visibility","hidden")},compositionComplete:function(n,t,i){var r=s.getDialog(i.model),u=f(n),o=u.find("img").filter(function(){var n=f(this);return!(this.style.width&&this.style.height)&&!(n.attr("width")&&n.attr("height"))}),e;u.data("predefinedWidth",u.get(0).style.width);e=function(n,t){setTimeout(function(){var i=f(n);t.context.reposition(n);f(t.host).css("opacity",1);i.css("visibility","visible");i.find(".autofocus").first().focus()},1)};e(n,r);o.load(function(){e(n,r)});(u.hasClass("autoclose")||i.model.autoclose)&&f(r.blockout).click(function(){r.close()})},reposition:function(n){var t=f(n),u=f(window);t.data("predefinedWidth")||t.css({width:""});t.css({height:""});var e=t.outerWidth(!1),o=t.outerHeight(!1),i=u.height()-2*this.minYMargin,r=u.width()-2*this.minXMargin,h=Math.min(o,i),s=Math.min(e,r);t.css({"margin-top":(-h/2).toString()+"px","margin-left":(-s/2).toString()+"px"});o>i?t.css("overflow-y","auto").outerHeight(i):t.css({"overflow-y":"",height:""});e>r?t.css("overflow-x","auto").outerWidth(r):(t.css("overflow-x",""),t.data("predefinedWidth")?t.css("width",t.data("predefinedWidth")):t.outerWidth(s))}}),s})