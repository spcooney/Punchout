define(["durandal/system","knockout"],function(n,t){function e(t){return t==undefined&&(t={}),n.isBoolean(t.closeOnDeactivate)||(t.closeOnDeactivate=i.defaults.closeOnDeactivate),t.beforeActivate||(t.beforeActivate=i.defaults.beforeActivate),t.afterDeactivate||(t.afterDeactivate=i.defaults.afterDeactivate),t.affirmations||(t.affirmations=i.defaults.affirmations),t.interpretResponse||(t.interpretResponse=i.defaults.interpretResponse),t.areSameItem||(t.areSameItem=i.defaults.areSameItem),t.findChildActivator||(t.findChildActivator=i.defaults.findChildActivator),t}function r(t,i,r){return n.isArray(r)?t[i].apply(t,r):t[i](r)}function u(t,i,r,u,f){if(t&&t.deactivate){n.log("Deactivating",t);var e;try{e=t.deactivate(i)}catch(o){n.log("ERROR: "+o.message,o);u.resolve(!1);return}e&&e.then?e.then(function(){r.afterDeactivate(t,i,f);u.resolve(!0)},function(t){t&&n.log(t);u.resolve(!1)}):(r.afterDeactivate(t,i,f),u.resolve(!0))}else t&&r.afterDeactivate(t,i,f),u.resolve(!0)}function o(t,i,u,f){var e;if(t&&t.activate){n.log("Activating",t);try{e=r(t,"activate",f)}catch(o){n.log("ERROR: "+o.message,o);u(!1);return}}e&&e.then?e.then(function(){i(t);u(!0)},function(t){t&&n.log("ERROR: "+t.message,t);u(!1)}):(i(t),u(!0))}function s(t,i,r,u){return u=n.extend({},f,u),r.lifecycleData=null,n.defer(function(f){function e(){if(t&&t.canDeactivate&&u.canDeactivate){var e;try{e=t.canDeactivate(i)}catch(o){n.log("ERROR: "+o.message,o);f.resolve(!1);return}e.then?e.then(function(n){r.lifecycleData=n;f.resolve(r.interpretResponse(n))},function(t){t&&n.log("ERROR: "+t.message,t);f.resolve(!1)}):(r.lifecycleData=e,f.resolve(r.interpretResponse(e)))}else f.resolve(!0)}var o=r.findChildActivator(t);o?o.canDeactivate().then(function(n){n?e():f.resolve(!1)}):e()}).promise()}function h(t,i,u,f,e){return u.lifecycleData=null,n.defer(function(o){if(u.areSameItem(i(),t,f,e)){o.resolve(!0);return}if(t&&t.canActivate){var s;try{s=r(t,"canActivate",e)}catch(h){n.log("ERROR: "+h.message,h);o.resolve(!1);return}s.then?s.then(function(n){u.lifecycleData=n;o.resolve(u.interpretResponse(n))},function(t){t&&n.log("ERROR: "+t.message,t);o.resolve(!1)}):(u.lifecycleData=s,o.resolve(u.interpretResponse(s)))}else o.resolve(!0)}).promise()}function c(i,r){var c=t.observable(null),l,f;return r=e(r),f=t.computed({read:function(){return c()},write:function(n){f.viaSetter=!0;f.activateItem(n)}}),f.__activator__=!0,f.settings=r,r.activator=f,f.isActivating=t.observable(!1),f.forceActiveItem=function(n){c(n)},f.canDeactivateItem=function(n,t,i){return s(n,t,r,i)},f.deactivateItem=function(t,i){return n.defer(function(n){f.canDeactivateItem(t,i).then(function(e){e?u(t,i,r,n,c):(f.notifySubscribers(),n.resolve(!1))})}).promise()},f.canActivateItem=function(n,t){return h(n,c,r,l,t)},f.activateItem=function(t,i,e){var s=f.viaSetter;return f.viaSetter=!1,n.defer(function(h){if(f.isActivating()){h.resolve(!1);return}f.isActivating(!0);var a=c();if(r.areSameItem(a,t,l,i)){f.isActivating(!1);h.resolve(!0);return}f.canDeactivateItem(a,r.closeOnDeactivate,e).then(function(e){e?f.canActivateItem(t,i).then(function(e){e?n.defer(function(n){u(a,r.closeOnDeactivate,r,n)}).promise().then(function(){t=r.beforeActivate(t,i);o(t,c,function(n){l=i;f.isActivating(!1);h.resolve(n)},i)}):(s&&f.notifySubscribers(),f.isActivating(!1),h.resolve(!1))}):(s&&f.notifySubscribers(),f.isActivating(!1),h.resolve(!1))})}).promise()},f.canActivate=function(){var n;return i?(n=i,i=!1):n=f(),f.canActivateItem(n)},f.activate=function(){var n;return i?(n=i,i=!1):n=f(),f.activateItem(n)},f.canDeactivate=function(n){return f.canDeactivateItem(f(),n)},f.deactivate=function(n){return f.deactivateItem(f(),n)},f.includeIn=function(n){n.canActivate=function(){return f.canActivate()};n.activate=function(){return f.activate()};n.canDeactivate=function(n){return f.canDeactivate(n)};n.deactivate=function(n){return f.deactivate(n)}},r.includeIn?f.includeIn(r.includeIn):i&&f.activate(),f.forItems=function(t){var i,u;return r.closeOnDeactivate=!1,r.determineNextItemToActivate=function(n,t){var i=t-1;return i==-1&&n.length>1?n[1]:i>-1&&i<n.length-1?n[i]:null},r.beforeActivate=function(n){var u=f(),i;return n?(i=t.indexOf(n),i==-1?t.push(n):n=t()[i]):n=r.determineNextItemToActivate(t,u?t.indexOf(u):0),n},r.afterDeactivate=function(n,i){i&&t.remove(n)},i=f.canDeactivate,f.canDeactivate=function(r){return r?n.defer(function(n){function o(){for(var t=0;t<i.length;t++)if(!i[t]){n.resolve(!1);return}n.resolve(!0)}for(var u=t(),i=[],e=0;e<u.length;e++)f.canDeactivateItem(u[e],r).then(function(n){i.push(n);i.length==u.length&&o()})}).promise():i()},u=f.deactivate,f.deactivate=function(i){return i?n.defer(function(n){function s(r){setTimeout(function(){f.deactivateItem(r,i).then(function(){e++;t.remove(r);e==o&&n.resolve()})},1)}for(var u=t(),e=0,o=u.length,r=0;r<o;r++)s(u[r])}).promise():u()},f},f}var i,f={canDeactivate:!0},l={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(i){return(n.isObject(i)&&(i=i.can||!1),n.isString(i))?t.utils.arrayIndexOf(this.affirmations,i.toLowerCase())!==-1:i},areSameItem:function(n,t){return n==t},beforeActivate:function(n){return n},afterDeactivate:function(n,t,i){t&&i&&i(null)},findChildActivator:function(){return null}};return i={defaults:l,create:c,isActivator:function(n){return n&&n.__activator__}}})