define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(n,t,i,r,u,f,e){function s(t,i,r){try{if(t.onError)try{t.onError(i,r)}catch(u){n.error(u)}else n.error(i)}finally{h(t,r,!0)}}function rt(n){for(var r=[],i={childElements:r,activeView:null},t=e.virtualElements.firstChild(n);t;)t.nodeType==1&&(r.push(t),t.getAttribute(v)&&(i.activeView=t)),t=e.virtualElements.nextSibling(t);return i.activeView||(i.activeView=r[0]),i}function h(n,t,i){if(l--,l===0){var r=c;c=[];i||setTimeout(function(){for(var i=r.length;i--;)try{r[i]()}catch(u){s(n,u,t)}},1)}ut(n)}function ut(n){delete n.activeView;delete n.viewElements}function ft(t,i,r,u){if(r)i();else if(t.activate&&t.model&&t.model.activate){var f;try{f=n.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData);f&&f.then?f.then(i,function(n){s(t,n,u);i()}):f||f===undefined?i():h(t,u)}catch(e){s(t,e,u)}}else i()}function et(t,i){var t=this;if(t.activeView&&t.activeView.removeAttribute(v),t.child)try{t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t);t.attached&&t.attached(t.child,t.parent,t);t.child.setAttribute(v,!0);t.composingNewView&&t.model&&t.model.detached&&e.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(n){s(t,n,i)}})}catch(r){s(t,r,i)}t.triggerAttach=n.noop}function ot(t){if(n.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var i=t.activeView.getAttribute("data-view"),r=t.child.getAttribute("data-view");return i!=r}}return!0}return!1}function p(n){for(var r,t=0,u=n.length,i=[];t<u;t++)r=n[t].cloneNode(!0),i.push(r);return i}function k(t){var e=p(t.parts),u=o.getParts(e),s=o.getParts(t.child),r,i;for(r in u){if(i=s[r],!i&&(i=f('[data-part="'+r+'"]',t.child).get(0),!i)){n.log("Could not find part to override: "+r);continue}i.parentNode.replaceChild(u[r],i)}}function d(t){var r=e.virtualElements.childNodes(t.parent),i,u,f;if(!n.isArray(r)){for(f=[],i=0,u=r.length;i<u;i++)f[i]=r[i];r=f}for(i=1,u=r.length;i<u;i++)e.removeNode(r[i])}function a(n){e.utils.domData.set(n,b,n.style.display);n.style.display="none"}function g(n){var t=e.utils.domData.get(n,b);n.style.display=t==="none"?"block":t}function st(n){var i=n.getAttribute("data-bind"),t,r;if(!i)return!1;for(t=0,r=y.length;t<r;t++)if(i.indexOf(y[t])>-1)return!0;return!1}var nt={},v="data-active-view",o,c=[],l=0,w="durandal-composition-data",tt="data-part",it=["model","view","transition","area","strategy","activationData","onError"],b="durandal-visibility-data",y=["compose:"],ht={complete:function(n){c.push(n)}};return o={composeBindings:y,convertTransitionToModuleId:function(n){return"transitions/"+n},defaultTransitionName:null,current:ht,addBindingHandler:function(n,t,i){var r,u="composition-handler-"+n,f;t=t||e.bindingHandlers[n];i=i||function(){return undefined};f=e.bindingHandlers[n]={init:function(n,r,f,s,h){if(l>0){var c={trigger:e.observable(null)};o.current.complete(function(){t.init&&t.init(n,r,f,s,h);t.update&&(e.utils.domData.set(n,u,t),c.trigger("trigger"))});e.utils.domData.set(n,u,c)}else e.utils.domData.set(n,u,t),t.init&&t.init(n,r,f,s,h);return i(n,r,f,s,h)},update:function(n,t,i,r,f){var o=e.utils.domData.get(n,u);if(o.update)return o.update(n,t,i,r,f);o.trigger&&o.trigger()}};for(r in t)r!=="init"&&r!=="update"&&(f[r]=t[r])},getParts:function(n,t){var r,f,i,u;if(t=t||{},!n)return t;for(n.length===undefined&&(n=[n]),r=0,f=n.length;r<f;r++)i=n[r],i.getAttribute&&(u=i.getAttribute(tt),u&&(t[u]=i),i.hasChildNodes()&&!st(i)&&o.getParts(i.childNodes,t));return t},cloneNodes:p,finalize:function(t,r){var f,u;t.transition===undefined&&(t.transition=this.defaultTransitionName);t.child||t.activeView?ot(t)?(f=this.convertTransitionToModuleId(t.transition),n.acquire(f).then(function(n){t.transition=n;n(t).then(function(){if(t.cacheViews){if(t.activeView){var n=i.getBindingInstruction(t.activeView);n&&n.cacheViews!=undefined&&!n.cacheViews?e.removeNode(t.activeView):a(t.activeView)}}else t.child?d(t):e.virtualElements.emptyNode(t.parent);t.child&&g(t.child);t.triggerAttach(t,r);h(t,r)})}).fail(function(n){s(t,"Failed to load transition ("+f+"). Details: "+n.message,r)})):(t.child!=t.activeView&&(t.cacheViews&&t.activeView&&(u=i.getBindingInstruction(t.activeView),u&&(u.cacheViews==undefined||u.cacheViews)?a(t.activeView):e.removeNode(t.activeView)),t.child?(t.cacheViews||d(t),g(t.child)):t.cacheViews||e.virtualElements.emptyNode(t.parent)),t.triggerAttach(t,r),h(t,r)):(t.cacheViews||e.virtualElements.emptyNode(t.parent),t.triggerAttach(t,r),h(t,r))},bindAndShow:function(n,t,u,f){u.child=n;u.parent.__composition_context=u;u.composingNewView=u.cacheViews?e.utils.arrayIndexOf(u.viewElements,n)==-1:!0;ft(u,function(){if(u.parent.__composition_context==u){try{delete u.parent.__composition_context}catch(c){u.parent.__composition_context=undefined}if(u.binding&&u.binding(u.child,u.parent,u),u.preserveContext&&u.bindingContext)u.composingNewView&&(u.parts&&k(u),a(n),e.virtualElements.prepend(u.parent,n),i.bindContext(u.bindingContext,n,u.model,u.as));else if(n){var f=u.model||nt,s=e.dataFor(n);if(s!=f){if(!u.composingNewView){e.removeNode(n);r.createView(n.getAttribute("data-view")).then(function(n){o.bindAndShow(n,t,u,!0)});return}u.parts&&k(u);a(n);e.virtualElements.prepend(u.parent,n);i.bind(f,n)}}o.finalize(u,t)}else h(u,t)},f,t)},defaultStrategy:function(n){return t.locateViewForObject(n.model,n.area,n.viewElements)},getSettings:function(t){var s=t(),i=e.utils.unwrapObservable(s)||{},f=u.isActivator(s),h,o;if(n.isString(i))return r.isViewUrl(i)?{view:i}:{model:i,activate:!f};if(h=n.getModuleId(i),h)return{model:i,activate:!f};!f&&i.model&&(f=u.isActivator(i.model));for(o in i)i[o]=e.utils.arrayIndexOf(it,o)!=-1?e.utils.unwrapObservable(i[o]):i[o];return f?i.activate=!1:i.activate===undefined&&(i.activate=!0),i},executeStrategy:function(n,t){n.strategy(n).then(function(i){o.bindAndShow(i,t,n)})},inject:function(i,r){if(!i.model){this.bindAndShow(null,r,i);return}if(i.view){t.locateView(i.view,i.area,i.viewElements).then(function(n){o.bindAndShow(n,r,i)});return}i.strategy||(i.strategy=this.defaultStrategy);n.isString(i.strategy)?n.acquire(i.strategy).then(function(n){i.strategy=n;o.executeStrategy(i,r)}).fail(function(n){s(i,"Failed to load view strategy ("+i.strategy+"). Details: "+n.message,r)}):this.executeStrategy(i,r)},compose:function(i,r,u,f){l++;f||(r=o.getSettings(function(){return r},i));r.compositionComplete&&c.push(function(){r.compositionComplete(r.child,r.parent,r)});c.push(function(){r.composingNewView&&r.model&&r.model.compositionComplete&&r.model.compositionComplete(r.child,r.parent,r)});var e=rt(i);r.activeView=e.activeView;r.parent=i;r.triggerAttach=et;r.bindingContext=u;r.cacheViews&&!r.viewElements&&(r.viewElements=e.childElements);r.model?n.isString(r.model)?n.acquire(r.model).then(function(t){r.model=n.resolveObject(t);o.inject(r,i)}).fail(function(n){s(r,"Failed to load composed module ("+r.model+"). Details: "+n.message,i)}):o.inject(r,i):r.view?(r.area=r.area||"partial",r.preserveContext=!0,t.locateView(r.view,r.area,r.viewElements).then(function(n){o.bindAndShow(n,i,r)})):this.bindAndShow(null,i,r)}},e.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(n,t,i,u,f){var s=o.getSettings(t,n),h,c;s.mode&&(h=e.utils.domData.get(n,w),h||(c=e.virtualElements.childNodes(n),h={},s.mode==="inline"?h.view=r.ensureSingleElement(c):s.mode==="templated"&&(h.parts=p(c)),e.virtualElements.emptyNode(n),e.utils.domData.set(n,w,h)),s.mode==="inline"?s.view=h.view.cloneNode(!0):s.mode==="templated"&&(s.parts=h.parts),s.preserveContext=!0);o.compose(n,s,f,!0)}},e.virtualElements.allowedBindings.compose=!0,o})